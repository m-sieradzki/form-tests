<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if IE 9 ]><html class="ie9 no-js"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->

  <head>
    <title>form-test</title>

    <meta name="author" content="">
    <meta name="description" content="">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="html2canvas.min.js"></script>
    <script src="base64binary.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/input-autogrow/1.1.0/input-autogrow.min.js"></script>
    <script src="node_modules/blueimp-file-upload/js/vendor/jquery.ui.widget.js"              type="text/javascript"></script>
    <script src="node_modules/blueimp-file-upload/js/jquery.iframe-transport.js"              type="text/javascript"></script>
    <script src="node_modules/blueimp-file-upload/js/jquery.fileupload.js"                    type="text/javascript"></script>

    <script src="node_modules/cloudinary-jquery-file-upload/cloudinary-jquery-file-upload.js" type="text/javascript"></script>

    <link rel="stylesheet" href="stylesheet.css" />

    <script>
      /*window.fbAsyncInit = function() {
    	FB.init({
    	  appId            : '1450842851714218',
    	  autoLogAppEvents : true,
    	  xfbml            : true,
    	  version          : 'v2.10'
    	});
    	FB.AppEvents.logPageView();
      };

      (function(d, s, id){
    	 var js, fjs = d.getElementsByTagName(s)[0];
    	 if (d.getElementById(id)) {return;}
    	 js = d.createElement(s); js.id = id;
    	 js.src = "https://connect.facebook.net/en_US/sdk.js";
    	 fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));*/
    </script>

  </head>
    <body>

      <form id="form" class="form" name="Hustler" method="POST" netlify>
        <label for="fullname" class="stroke">
          I nominate&nbsp;
        </label>
        <div class="field">
          <input type="text" class="preview preview-name" id="Name" data-copy="#name" name="FNAME" id="mce-FNAME" required placeholder="name">&nbsp;
        </div>
        <label for="fullname" class="stroke">
          &#32;because they are &nbsp;
        </label>
        <div class="field">
          <input type="text" class="preview preview-reason" data-copy="#reason" name="REASON" id="mce-REASON" required placeholder="reason">
        </div>
        <label for="fullname" class="stroke">
          &nbsp;Tell them &nbsp;
        </label>
        <div class="field">
          <input type="text" class="preview preview-reason" data-copy="#sender" name="SENDER" id="mce-SENDER" required placeholder="your name">
        </div>
        <label for="fullname" class="stroke">
          &nbsp;did it.
        </label>
        <label for="fullname" class="stroke">
          Oh and here's where to tell them:&nbsp;
        </label>
        <div class="field">
          <input type="email" class="preview preview-reason" data-copy="#email" name="EMAIL" required placeholder="email" id="mce-EMAIL">
        </div>
        <label for="fullname" class="stroke">
          .
        </label>
        <button id="nominate" type="submit">Nominate</button>
      </form>

      <img id="uploaded" alt="title" />
      <div class="social-buttons"></div>
      <div id="results"></div>

      <!--
      <h1>Upload to Cloudinary with FormData</h1>
      <div>
      <p>

      Set your cloud name in the API URL in the code:  "https://api.cloudinary.com/v1_1/<strong>&lt;cloud&nbsp;name&gt;</strong>/image/upload" before running the example.
      </p>
      </div>
      <form action="" method="post" enctype="multipart/form-data" onsubmit="AJAXSubmit(this); return false;">
        <fieldset>
          <legend>Upload example</legend>
          <p>
            <label for="upload_preset">Unsigned upload Preset: <input type="text" name="upload_preset" value="testytest"></label>
          </p>
          <p>
            <label >Select your photo:
            <input class="image_upload" id="image_upload" type="file" name="file"></label>
          </p>

          <p>
            <input type="submit" value="Submit" />
          </p>
          <img id="uploaded">
          <div id="results"></div>
        </fieldset>
      </form>
    -->

      <div id="capture">
        <span class="stroke-two">
          You nominate&nbsp;
        </span>
        <span id="reason">
          <span class="stroke-two">
            because they are&nbsp;
          </span>
          <span class="stroke-two">
            &nbsp;.
          </span>
        </span>

      </div>

      <div id="show">
      SHOW
      </div>

      <div id="save">
      SAVE
      </div>

      <div id="upload">
      UPLOAD
      </div>

      <div id="artboard">
      </div>

      <!--<img id="testimage" src="file-name.png"></img>-->

<script type="text/javascript">
        $(document).ready(function() {

          $.cloudinary.config({
            "cloud_name": "mariaxxix",
            "api_key": "578125755345546",
            "uploadPreset": "testytest",
            "private_cdn": false,
            "cdn_subdomain": false
          });

          $(function() {
            if($.fn.cloudinary_fileupload !== undefined) {
              $("input.cloudinary-fileupload[type=file]").cloudinary_fileupload();
            }
          });


          window.ajaxSuccess = function () {
          	response = JSON.parse(this.responseText);
            console.log("ajaxSuccess", typeof this.responseText);
            document.getElementById('uploaded').setAttribute("src", response["secure_url"]);
            document.getElementById('results').innerText = this.responseText;
          }

          window.AJAXSubmit = function (formElement) {
            console.log("starting AJAXSubmit");
            if (!formElement.action) { return; }
            var xhr = new XMLHttpRequest();
            xhr.onload = ajaxSuccess;
            xhr.open("post", "https://api.cloudinary.com/v1_1/mariaxxix/image/upload",false);
            xhr.send(new FormData(formElement));
          }

          $('#uploaded').click(function(){
            var imageSrc = $(this).attr('src');

            $("meta[property='twitter\\:image']").attr("content", imageSrc);
            window.open('https://twitter.com/intent/tweet?text=https://awesome-haibt-71e116.netlify.com/', '_blank');

            // FACEBOOK
            FB.ui({
          		method: 'share_open_graph',
          		action_type: 'og.likes',
          		action_properties: JSON.stringify({
          			object: {
          				'og:url': window.location.href,
          				'og:title': 'form-test',
          				'og:description': 'I nominated',
          				'og:image': imageSrc
          			}
          		})
          	},
          	function (response) {
          	// Action after response
          	});
          })

$('input').inputAutogrow({
minWidth: 50,
trailingSpace: -100
});

  $(".preview").on('keyup', function() {
    $("#capture").html('<strong class="stroke-two">You nominate&#32; </strong>' + $(".preview-name").val() + "&#32;" + '<strong class="stroke-two">because they are&#32;</strong>' + $(".preview-reason").val() + '<strong class="stroke-two">.</strong>');
  });
});

var artboard;
$("#show").click(function() {

html2canvas(document.querySelector("#capture"),{useCORS:true,async:true}).then(canvas => {
  document.querySelector("#artboard").appendChild(canvas);
  canvas.id = "canvas"
  var flatten = canvas.getContext('2d');
  var data = canvas.toDataURL("image/png");
  var file = dataURItoBlob(data);
  //var encodedPng = data.substring(data.indexOf(',') + 1, data.length);
  //var decodedPng = Base64Binary.decode(encodedPng);
  var image = new Image();
  image.id = "pic";
  image.src = data;
  //img.crossOrigin = "Anonymous";
  document.getElementById('artboard').appendChild(image);



  function dataURItoBlob(dataURI) {
    // convert base64 to raw binary data held in a string
    var byteString = atob(dataURI.split(',')[1]);

    // separate out the mime component
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

    // write the bytes of the string to an ArrayBuffer
    var arrayBuffer = new ArrayBuffer(byteString.length);
    var _ia = new Uint8Array(arrayBuffer);
    for (var i = 0; i < byteString.length; i++) {
        _ia[i] = byteString.charCodeAt(i);
    }

    var dataView = new DataView(arrayBuffer);
    var blob = new Blob([dataView], { type: mimeString });
    return blob;
}

    const dT = new ClipboardEvent('').clipboardData || // Firefox < 62 workaround exploiting https://bugzilla.mozilla.org/show_bug.cgi?id=1422655
    new DataTransfer(); // specs compliant (as of March 2018 only Chrome)
    dT.items.add(new File(['test image'], data));
    document.querySelector('#image_upload').files = dT.files;
    });
//console.log(artboard);
//var file = dataURItoBlob(img);
//document.querySelector('#mce-URL').files = file;
});

$("#save").click(function() {
  html2canvas(document.querySelector("#capture")).then(canvas => {

    //document.querySelector('#mce-URL').files = canvas.toDataURL('image/png');
    //saveAs(canvas.toDataURL('image/png'), 'file-name.png');
  });
});

$("#upload").click(function() {
  html2canvas(document.querySelector("#capture")).then(canvas => {
    canvas.id = "canvas";
    var flatten = canvas.getContext('2d');
    var data = canvas.toDataURL("image/png");
    const dataSend = new FormData();
    var uploadPreset = 'testytest';
    dataSend.append('upload_preset', uploadPreset);
    dataSend.append('file', data);
    var xhr = new XMLHttpRequest();
    xhr.onload = ajaxSuccess;
    xhr.open("post", "https://api.cloudinary.com/v1_1/mariaxxix/image/upload");
    xhr.send(dataSend);
  });
});

function saveAs(uri, filename) {

var link = document.createElement('a');

if (typeof link.download === 'string') {

    link.href = uri;
    link.download = filename;

    //Firefox requires the link to be in the body
    document.body.appendChild(link);

    //simulate click
    link.click();

    //remove the link when done
    document.body.removeChild(link);

} else {

    window.open(uri);

};
};
        </script>
        <!--<script type="text/javascript" src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c0cf92d141c0a23"></script>-->
    </body>
  </html>
